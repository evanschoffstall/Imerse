// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// Core Models

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  password      String // Required for security - use OAuth providers if passwordless auth is needed
  avatar        String?
  emailVerified DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  campaigns     Campaign[]
  campaignRoles CampaignRole[]
  characters    Character[]
  locations     Location[]
  items         Item[]
  quests        Quest[]
  events        Event[]
  journals      Journal[]
  notes         Note[]
  families      Family[]
  races         Race[]
  organisations Organisation[]
  tags          Tag[]
  timelines     Timeline[]
  maps          Map[]
  relations     Relation[]
  calendars     Calendar[]
  attributes    Attribute[]
  relationships Relationship[]
  versions      Version[]
  mapLayers     MapLayer[]
  mapMarkers    MapMarker[]
  mapGroups     MapGroup[]
  abilities     Ability[]
  entityAbilities EntityAbility[]
  creatures     Creature[]
  diceRolls     DiceRoll[]
  diceRollResults DiceRollResult[]
  conversationsCreated Conversation[]
  conversationMessages ConversationMessage[] @relation("MessageCreator")
  conversationMessageAuthor ConversationMessage[]
  conversationParticipants ConversationParticipant[]

  @@map("users")
}

model Campaign {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?  @db.Text
  image       String?
  visibility  String   @default("private") // private, public
  locale      String   @default("en")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  ownerId String
  owner   User   @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  characters    Character[]
  locations     Location[]
  items         Item[]
  quests        Quest[]
  events        Event[]
  journals      Journal[]
  notes         Note[]
  families      Family[]
  races         Race[]
  organisations Organisation[]
  tags          Tag[]
  timelines     Timeline[]
  maps          Map[]
  campaignRoles CampaignRole[]
  relations     Relation[]
  calendars     Calendar[]
  attributes    Attribute[]
  relationships Relationship[]
  versions      Version[]
  abilities     Ability[]
  creatures     Creature[]
  diceRolls     DiceRoll[]
  conversations Conversation[]

  @@map("campaigns")
}

model CampaignRole {
  id          String   @id @default(cuid())
  campaignId  String
  userId      String
  role        String // member, admin, viewer
  isAdmin     Boolean  @default(false)
  permissions Json? // Granular permissions: ["read", "edit", "create", "delete", "manage_members", etc.]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([campaignId, userId])
  @@map("campaign_roles")
}

model Character {
  id          String  @id @default(cuid())
  name        String
  slug        String
  title       String?
  type        String?
  age         String?
  sex         String?
  pronouns    String?
  location    String?
  family      String?
  description String? @db.Text
  image       String?
  isPrivate   Boolean @default(false)

  // Birthday Tracking
  birthCalendarId String?
  birthCalendar   Calendar? @relation(fields: [birthCalendarId], references: [id], onDelete: SetNull)
  birthDate       String? // YYYY-MM-DD format in calendar system

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  diceRolls   DiceRoll[]
  conversationMessages ConversationMessage[]
  conversationParticipants ConversationParticipant[]

  @@unique([campaignId, slug])
  @@map("characters")
}

model Location {
  id          String   @id @default(cuid())
  name        String
  slug        String
  type        String?
  parentId    String?
  description String?  @db.Text
  image       String?
  mapImage    String?
  isPrivate   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  parent   Location?  @relation("LocationHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children Location[] @relation("LocationHierarchy")

  creatures CreatureLocation[]

  @@unique([campaignId, slug])
  @@map("locations")
}

model Item {
  id          String   @id @default(cuid())
  name        String
  slug        String
  type        String?
  description String?  @db.Text
  image       String?
  location    String?
  character   String?
  price       String?
  size        String?
  isPrivate   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@unique([campaignId, slug])
  @@map("items")
}

model Quest {
  id          String   @id @default(cuid())
  name        String
  slug        String
  type        String?
  description String?  @db.Text
  image       String?
  status      String?  @default("active") // active, completed, failed
  isPrivate   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@unique([campaignId, slug])
  @@map("quests")
}

model Event {
  id          String  @id @default(cuid())
  name        String
  slug        String
  type        String?
  date        String? // Legacy text date field
  description String? @db.Text
  image       String?
  location    String?
  isPrivate   Boolean @default(false)

  // Calendar Integration
  calendarId     String?
  calendar       Calendar? @relation(fields: [calendarId], references: [id], onDelete: SetNull)
  calendarDate   String? // YYYY-MM-DD format for calendar system
  isRecurring    Boolean   @default(false)
  recurrenceRule Json? // JSON: { type: 'daily'|'monthly'|'yearly'|'moon', interval: 1, endDate?: string }

  // Timeline Integration
  timelineId String?
  timeline   Timeline? @relation(fields: [timelineId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@unique([campaignId, slug])
  @@map("events")
}

model Journal {
  id          String   @id @default(cuid())
  name        String
  slug        String
  type        String?
  description String?  @db.Text
  date        String?
  image       String?
  isPrivate   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@unique([campaignId, slug])
  @@map("journals")
}

model Note {
  id          String   @id @default(cuid())
  name        String
  slug        String
  type        String?
  description String?  @db.Text
  image       String?
  isPrivate   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@unique([campaignId, slug])
  @@map("notes")
}

model Family {
  id          String   @id @default(cuid())
  name        String
  slug        String
  type        String?
  description String?  @db.Text
  image       String?
  location    String?
  isPrivate   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@unique([campaignId, slug])
  @@map("families")
}

model Race {
  id          String   @id @default(cuid())
  name        String
  slug        String
  type        String?
  description String?  @db.Text
  image       String?
  isPrivate   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@unique([campaignId, slug])
  @@map("races")
}

model Organisation {
  id          String   @id @default(cuid())
  name        String
  slug        String
  type        String?
  description String?  @db.Text
  image       String?
  location    String?
  isPrivate   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@unique([campaignId, slug])
  @@map("organisations")
}

model Tag {
  id          String   @id @default(cuid())
  name        String
  slug        String
  type        String?
  description String?  @db.Text
  color       String?
  isPrivate   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@unique([campaignId, slug])
  @@map("tags")
}

model Timeline {
  id          String   @id @default(cuid())
  name        String
  slug        String
  type        String?
  description String?  @db.Text
  image       String?
  startDate   String? // Optional start date for timeline range (flexible format)
  endDate     String? // Optional end date for timeline range (flexible format)
  isPrivate   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  events Event[]

  @@unique([campaignId, slug])
  @@map("timelines")
}

model Map {
  id          String   @id @default(cuid())
  name        String
  slug        String
  type        String?
  description String?  @db.Text
  image       String?
  grid        Json?
  isPrivate   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  layers  MapLayer[]
  markers MapMarker[]
  groups  MapGroup[]

  @@unique([campaignId, slug])
  @@map("maps")
}

model Relation {
  id         String   @id @default(cuid())
  relation   String // Relationship type (e.g., "parent", "sibling", "ally", "enemy", "friend")
  attitude   Int      @default(0) // -3 (hostile) to +3 (friendly)
  colour     String? // Hex color for visualization
  isPinned   Boolean  @default(false)
  visibility String   @default("all") // all, admin, self
  mirrorId   String?  @unique // ID of the reciprocal relation
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Owner is the source entity of the relation
  ownerId   String
  ownerType String // Entity type (e.g., "character", "location")

  // Target is the destination entity of the relation
  targetId   String
  targetType String // Entity type

  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  // Self-reference for bidirectional relations
  mirror   Relation? @relation("RelationMirror", fields: [mirrorId], references: [id], onDelete: SetNull)
  mirrorOf Relation? @relation("RelationMirror")

  @@index([ownerId, ownerType])
  @@index([targetId, targetType])
  @@index([campaignId])
  @@map("relations")
}

model Calendar {
  id          String  @id @default(cuid())
  name        String
  slug        String
  description String? @db.Text
  image       String?

  // Current date of the calendar (format: YYYY-MM-DD)
  date String? // e.g., "2024-03-15"

  // Calendar configuration (stored as JSON)
  months       Json? // Array of {name: string, length: number, intercalary?: boolean}
  weekdays     Json? // Array of weekday names
  years        Json? // Object mapping year numbers to custom names/eras
  seasons      Json? // Array of {name: string, month: number, color?: string}
  moons        Json? // Array of {id: string, name: string, fullmoon: number, newmoon: number, offset: number, colour?: string}
  weekNames    Json? // Array of week names
  monthAliases Json? // Object mapping month indices to alternative names

  // Date formatting
  suffix String? // Suffix for dates (e.g., "AD", "BR" for "Before Ragnarok")
  format String? // Date format string

  // Leap year configuration
  hasLeapYear    Boolean @default(false)
  leapYearAmount Int? // Number of days to add
  leapYearMonth  Int? // Month to add leap days to (1-based)
  leapYearOffset Int? // Leap year occurs every X years
  leapYearStart  Int? // First leap year

  // Advanced settings
  startOffset   Int     @default(0) // Day of week that year starts on (0-6)
  skipYearZero  Boolean @default(false) // Whether calendar skips year 0
  showBirthdays Boolean @default(true)
  parameters    Json? // Additional calendar parameters (e.g., {layout: "yearly"})

  isPrivate Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Nested calendar support (parent-child hierarchy)
  parentId String?
  parent   Calendar?  @relation("CalendarHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children Calendar[] @relation("CalendarHierarchy")

  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  weather            CalendarWeather[]
  events             Event[]
  characterBirthdays Character[]

  @@unique([campaignId, slug])
  @@index([campaignId])
  @@index([parentId])
  @@map("calendars")
}

model CalendarWeather {
  id            String  @id @default(cuid())
  date          String // YYYY-MM-DD format
  weatherType   String? // Weather type (e.g., "sunny", "rain", "snow", "storm")
  temperature   String? // Temperature description or value
  precipitation String? // Precipitation description
  wind          String? // Wind description
  effect        String? // Special effects or description

  visibility String   @default("all") // all, admin, self
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  calendarId String
  calendar   Calendar @relation(fields: [calendarId], references: [id], onDelete: Cascade)

  @@index([calendarId])
  @@index([calendarId, date])
  @@map("calendar_weather")
}
model Attribute {
  id          String   @id @default(cuid())
  entityType  String // 'character', 'item', 'location', 'quest', etc.
  entityId    String // ID of the entity this attribute belongs to
  key         String // Attribute name (e.g., "HP", "Strength", "Level")
  value       String // Attribute value (stored as string, parsed by type)
  type        String   @default("text") // 'text', 'number', 'boolean', 'date', 'url'
  category    String? // Optional grouping (e.g., "Stats", "Skills", "Properties")
  order       Int      @default(0) // Display order
  isPrivate   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@unique([entityType, entityId, key])
  @@index([campaignId])
  @@index([entityType, entityId])
  @@map("attributes")
}

model Relationship {
  id                 String   @id @default(cuid())
  sourceEntityType   String // 'character', 'location', 'item', etc.
  sourceEntityId     String // ID of the source entity
  targetEntityType   String // 'character', 'location', 'item', etc.
  targetEntityId     String // ID of the target entity
  relationshipType   String // 'ally', 'enemy', 'family', 'member', 'owns', 'located_in', etc.
  description        String? // Optional description of the relationship
  metadata           Json? // Additional flexible data (e.g., relationship strength, tags)
  bidirectional      Boolean  @default(false) // If true, relationship works both ways
  isPrivate          Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([sourceEntityType, sourceEntityId])
  @@index([targetEntityType, targetEntityId])
  @@index([relationshipType])
  @@map("relationships")
}

model Version {
  id             String   @id @default(cuid())
  entityType     String // 'character', 'location', 'item', etc.
  entityId       String // ID of the versioned entity
  versionNumber  Int // Sequential version number (1, 2, 3, ...)
  snapshot       Json // Complete entity state at this version
  changeType     String   @default("update") // 'create', 'update', 'delete'
  changesMade    String? // Human-readable summary of changes
  changedFields  Json? // List of field names that changed
  createdAt      DateTime @default(now())

  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@unique([entityType, entityId, versionNumber])
  @@index([campaignId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("versions")
}

model MapLayer {
  id          String   @id @default(cuid())
  name        String
  image       String? // Image path for the layer
  entry       String?  @db.Text // Rich text description
  position    Int      @default(0) // Z-index/ordering (higher = on top)
  width       Int? // Layer dimensions
  height      Int?
  opacity     Float    @default(1.0) // 0.0 to 1.0
  isVisible   Boolean  @default(true)
  isPrivate   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  mapId String
  map   Map    @relation(fields: [mapId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([mapId])
  @@index([mapId, position])
  @@map("map_layers")
}

model MapGroup {
  id         String   @id @default(cuid())
  name       String
  position   Int      @default(0) // Display order
  isShown    Boolean  @default(true) // Visibility toggle for entire group
  isPrivate  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  mapId String
  map   Map    @relation(fields: [mapId], references: [id], onDelete: Cascade)

  parentId String?
  parent   MapGroup?   @relation("MapGroupHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children MapGroup[]  @relation("MapGroupHierarchy")

  markers MapMarker[]

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([mapId])
  @@index([parentId])
  @@map("map_groups")
}

model MapMarker {
  id           String   @id @default(cuid())
  name         String
  entry        String?  @db.Text // Rich text description
  longitude    Float // X coordinate on map
  latitude     Float // Y coordinate on map
  
  // Appearance
  shape        String   @default("marker") // 'marker', 'circle', 'label', 'polygon'
  size         Int      @default(1) // Size multiplier (1-5)
  colour       String   @default("#ff0000") // Hex color
  fontColour   String   @default("#ffffff") // Text color for labels
  icon         String? // Icon identifier
  customIcon   String? // Custom icon path
  customShape  String? // Custom SVG shape or polygon coordinates (JSON)
  opacity      Float    @default(1.0) // 0.0 to 1.0
  
  // Circle-specific
  circleRadius Int? // Radius for circle markers
  
  // Polygon-specific
  polygonStyle Json? // {strokeWidth, strokeColor, fillColor, etc.}
  
  // Behavior
  isDraggable  Boolean  @default(false) // Can be moved on the map
  isPopupless  Boolean  @default(false) // Don't show popup on click
  pinSize      Int? // Pin size override
  css          String? // Custom CSS classes or styles
  
  // Relations
  entityId     String? // Optional link to a Character, Location, etc.
  entityType   String? // Type of linked entity
  
  isPrivate    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  mapId String
  map   Map    @relation(fields: [mapId], references: [id], onDelete: Cascade)

  groupId String?
  group   MapGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([mapId])
  @@index([groupId])
  @@index([entityType, entityId])
  @@map("map_markers")
}
model Ability {
  id          String   @id @default(cuid())
  name        String
  entry       String?  @db.Text // Rich text description
  charges     Int? // Number of uses/charges
  type        String? // Ability category/type
  isPrivate   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  // Hierarchical structure
  parentId String?
  parent   Ability?   @relation("AbilityHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children Ability[]  @relation("AbilityHierarchy")

  // Entity links
  entityAbilities EntityAbility[]

  @@index([campaignId])
  @@index([parentId])
  @@index([campaignId, name])
  @@map("abilities")
}

model EntityAbility {
  id         String   @id @default(cuid())
  charges    Int? // Override ability charges
  position   Int      @default(0) // Display order
  note       String?  @db.Text // Custom notes
  isPrivate  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  entityId   String // Character, Creature, etc.
  entityType String // 'character', 'creature', etc.

  abilityId String
  ability   Ability @relation(fields: [abilityId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([entityType, entityId])
  @@index([abilityId])
  @@index([entityType, entityId, position])
  @@map("entity_abilities")
}

model Creature {
  id         String   @id @default(cuid())
  name       String
  entry      String?  @db.Text // Rich text description
  type       String? // Creature type/category (Beast, Humanoid, etc.)
  image      String? // Image path
  isExtinct  Boolean  @default(false)
  isDead     Boolean  @default(false)
  isPrivate  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  // Hierarchical structure
  parentId String?
  parent   Creature?   @relation("CreatureHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children Creature[]  @relation("CreatureHierarchy")

  // Location relationships
  locations CreatureLocation[]

  @@index([campaignId])
  @@index([parentId])
  @@index([campaignId, name])
  @@index([type])
  @@map("creatures")
}

model CreatureLocation {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  creatureId String
  creature   Creature @relation(fields: [creatureId], references: [id], onDelete: Cascade)

  locationId String
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([creatureId, locationId])
  @@index([creatureId])
  @@index([locationId])
  @@map("creature_locations")
}

model DiceRoll {
  id         String   @id @default(cuid())
  name       String
  system     String?  // System name (d20, d100, etc.)
  parameters String   @db.Text // Dice expression (3d6+2, 1d20+{character.strength}, etc.)
  isPrivate  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  // Optional character link for attribute substitution
  characterId String?
  character   Character? @relation(fields: [characterId], references: [id], onDelete: SetNull)

  results DiceRollResult[]

  @@index([campaignId])
  @@index([characterId])
  @@index([campaignId, name])
  @@map("dice_rolls")
}

model DiceRollResult {
  id        String   @id @default(cuid())
  results   String   @db.Text // JSON array of roll results and details
  isPrivate Boolean  @default(false)
  createdAt DateTime @default(now())

  diceRollId String
  diceRoll   DiceRoll @relation(fields: [diceRollId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([diceRollId])
  @@index([createdById])
  @@index([diceRollId, createdAt])
  @@map("dice_roll_results")
}

model Conversation {
  id        String   @id @default(cuid())
  name      String
  target    String   @default("characters") // "users" or "characters"
  isPrivate Boolean  @default(false)
  isClosed  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade)

  messages     ConversationMessage[]
  participants ConversationParticipant[]

  @@index([campaignId])
  @@index([campaignId, name])
  @@index([isClosed])
  @@map("conversations")
}

model ConversationMessage {
  id        String   @id @default(cuid())
  message   String   @db.Text
  createdAt DateTime @default(now())

  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  // Author can be either user or character
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  characterId String?
  character   Character? @relation(fields: [characterId], references: [id], onDelete: SetNull)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id], onDelete: Cascade, name: "MessageCreator")

  @@index([conversationId])
  @@index([userId])
  @@index([characterId])
  @@index([conversationId, createdAt])
  @@map("conversation_messages")
}

model ConversationParticipant {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  // Participant can be either user or character
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  characterId String?
  character   Character? @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId, characterId])
  @@index([conversationId])
  @@index([userId])
  @@index([characterId])
  @@map("conversation_participants")
}
